// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Plan {
  free
  pro
  premium
}

enum PlantPrimaryType {
  TREE
  SHRUB
  HERBACEOUS
  VINE_CLIMBER
  FERN
  SUCCULENT
  GRASS
  FUNGUS
  AQUATIC
}

enum TraitCategory {
  BLOOMING_LIFECYCLE
  ENVIRONMENT_GROWTH
  USE_ORIGIN
}

model User {
  id                    String                @id @default(uuid())
  username              String                @unique
  email                 String                @unique
  password              String
  firstName             String
  lastName              String
  avatarUrl             String?
  bannerUrl             String?
  bio                   String?
  essence               Int                   @default(0)
  joinedAt              DateTime              @default(now())
  plan                  Plan                  @default(free)
  plants                Plant[]
  collections           Collection[]
  
  // Stripe integration
  stripeCustomerId      String?               @unique
  stripeCustomer        StripeCustomer?
  subscriptions         Subscription[]
  preferences           UserPreference?
  careReminders         CareReminder[]
  likes                 PlantLike[]
  usernameLastChangedAt DateTime?
  
  // Forum relations
  forumThreads          ForumThread[]
  forumReplies          ForumReply[]
  threadSubscriptions   ForumThread[]         @relation("ThreadSubscriptions")
  forumLikes            Like[]
}

model Plant {
  id                   String     @id @default(cuid())
  commonName           String
  botanicalName        String
  description          String
  likes                Int        @default(0)
  slug                 String
  origin               String?
  family               String?
  type                 String?
  primaryType          PlantPrimaryType?
  secondaryTraits      String[]   @default([])
  plantTraits          PlantTrait[]
  views                Int        @default(0)
  isPublic             Boolean    @default(true)
  isGarden             Boolean    @default(false)
  userId               String
  user                 User       @relation(fields: [userId], references: [id])
  collection           Collection @relation(fields: [collectionId], references: [id])
  collectionId         String
  originalCollectionId String?
  originalCollection   Collection? @relation("OriginalCollection", fields: [originalCollectionId], references: [id])

  tags   Tag[]   @relation("PlantTags")
  images Image[]
  careReminders CareReminder[]
  plantLikes    PlantLike[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([slug, userId], name: "slug_userId")
  @@index([primaryType])
}

model Image {
  id         String       @id @default(cuid())
  url        String
  isMain     Boolean      @default(false)
  plantId    String
  plant      Plant        @relation(fields: [plantId], references: [id])
  Collection Collection[]
}

model Tag {
  id     String  @id @default(cuid())
  name   String  @unique
  plants Plant[] @relation("PlantTags")
}

model Trait {
  id        String        @id @default(cuid())
  name      String        @unique
  slug      String        @unique
  category  TraitCategory
  plants    PlantTrait[]

  @@index([slug])
  @@index([category])
}

model PlantTrait {
  plantId   String
  traitId   String
  plant     Plant   @relation(fields: [plantId], references: [id], onDelete: Cascade)
  trait     Trait   @relation(fields: [traitId], references: [id], onDelete: Cascade)

  @@id([plantId, traitId])
  @@index([traitId])
}

model Collection {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  userId String

  plants                  Plant[]
  originallyCreatedPlants Plant[] @relation("OriginalCollection")

  thumbnailImage   Image?  @relation(fields: [thumbnailImageId], references: [id])
  thumbnailImageId String?
}

// Stripe models
model StripeCustomer {
  id                String    @id @default(cuid())
  stripeCustomerId  String    @unique
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Subscription {
  id                        String    @id @default(cuid())
  stripeSubscriptionId      String    @unique
  userId                    String
  user                      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                      Plan
  status                    String    // active, past_due, canceled, unpaid, etc.
  currentPeriodStart        DateTime
  currentPeriodEnd          DateTime
  canceledAt                DateTime?
  cancelAtPeriodEnd         Boolean   @default(false)
  trialEnd                  DateTime?
  priceId                   String
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  
  @@index([userId])
  @@index([stripeSubscriptionId])
}

model StripeEvent {
  id                String    @id @default(cuid())
  stripeEventId     String    @unique
  type              String
  data              String    // JSON stringified event data
  processed         Boolean   @default(false)
  createdAt         DateTime  @default(now())
  
  @@index([stripeEventId])
  @@index([processed])
}

model UserPreference {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme             String    @default("dark")
  language          String    @default("en")
  emailNotifications Boolean  @default(true)
  pushNotifications  Boolean  @default(false)
  careReminders     Boolean   @default(true)
  reminderTime      String    @default("09:00")
  timezone          String    @default("America/New_York")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model PlantLike {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plantId   String
  plant     Plant    @relation(fields: [plantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, plantId])
  @@index([userId])
  @@index([plantId])
}

model CareReminder {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plantId           String
  plant             Plant     @relation(fields: [plantId], references: [id], onDelete: Cascade)
  type              String
  frequency         Int
  frequencyUnit     String    @default("days")
  lastCompleted     DateTime?
  nextDue           DateTime
  enabled           Boolean   @default(true)
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@index([plantId])
  @@index([nextDue])
}

// Forum Models
model ForumCategory {
  id          String        @id @default(cuid())
  name        String        @unique
  slug        String        @unique
  description String?
  icon        String?
  order       Int           @default(0)
  threads     ForumThread[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([slug])
  @@index([order])
}

model ForumThread {
  id            String         @id @default(cuid())
  title         String
  slug          String
  content       String         @db.Text
  images        String[]
  authorId      String
  author        User           @relation(fields: [authorId], references: [id])
  categoryId    String
  category      ForumCategory  @relation(fields: [categoryId], references: [id])
  isPinned      Boolean        @default(false)
  isLocked      Boolean        @default(false)
  viewCount     Int            @default(0)
  replies       ForumReply[]
  subscribers   User[]         @relation("ThreadSubscriptions")
  tags          String[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  lastReplyAt   DateTime?
  
  @@index([categoryId])
  @@index([authorId])
  @@index([slug])
  @@index([isPinned, createdAt])
}

model ForumReply {
  id        String      @id @default(cuid())
  content   String      @db.Text
  images    String[]
  threadId  String
  thread    ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  authorId  String
  author    User        @relation(fields: [authorId], references: [id])
  parentId  String?
  parent    ForumReply? @relation("ReplyReplies", fields: [parentId], references: [id])
  replies   ForumReply[] @relation("ReplyReplies")
  likes     Like[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  @@index([threadId])
  @@index([authorId])
}

model Like {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  replyId   String
  reply     ForumReply  @relation(fields: [replyId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())
  
  @@unique([userId, replyId])
  @@index([userId])
  @@index([replyId])
}
