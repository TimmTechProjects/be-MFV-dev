// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Plan {
  free
  pro
  premium
}

enum PlantPrimaryType {
  TREE
  SHRUB
  HERBACEOUS
  VINE_CLIMBER
  FERN
  SUCCULENT
  GRASS
  FUNGUS
  AQUATIC
}

enum TraitCategory {
  BLOOMING_LIFECYCLE
  ENVIRONMENT_GROWTH
  USE_ORIGIN
}

model User {
  id                    String                @id @default(uuid())
  username              String                @unique
  email                 String                @unique
  password              String
  firstName             String
  lastName              String
  avatarUrl             String?
  bannerUrl             String?
  bio                   String?
  essence               Int                   @default(0)
  joinedAt              DateTime              @default(now())
  plan                  Plan                  @default(free)
  plants                Plant[]
  collections           Collection[]
  
  // Stripe integration
  stripeCustomerId      String?               @unique
  stripeCustomer        StripeCustomer?
  subscriptions         Subscription[]
  preferences           UserPreference?
  careReminders         CareReminder[]
  likes                 PlantLike[]
  usernameLastChangedAt DateTime?

  // Social features
  posts              Post[]
  postLikes          PostLike[]
  postComments       PostComment[]
  forumThreads       ForumThread[]
  forumReplies       ForumReply[]
  forumThreadVotes   ForumThreadVote[]
  forumReplyVotes    ForumReplyVote[]
  notifications      Notification[]
  supportTickets     SupportTicket[]
  ticketMessages     TicketMessage[]
}

model Plant {
  id                   String     @id @default(cuid())
  commonName           String
  botanicalName        String
  description          String
  likes                Int        @default(0)
  slug                 String
  origin               String?
  family               String?
  type                 String?
  primaryType          PlantPrimaryType?
  secondaryTraits      String[]   @default([])
  plantTraits          PlantTrait[]
  views                Int        @default(0)
  isPublic             Boolean    @default(true)
  isGarden             Boolean    @default(false)
  userId               String
  user                 User       @relation(fields: [userId], references: [id])
  collection           Collection @relation(fields: [collectionId], references: [id])
  collectionId         String
  originalCollectionId String?
  originalCollection   Collection? @relation("OriginalCollection", fields: [originalCollectionId], references: [id])

  tags   Tag[]   @relation("PlantTags")
  images Image[]
  careReminders CareReminder[]
  plantLikes    PlantLike[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([slug, userId], name: "slug_userId")
  @@index([primaryType])
}

model Image {
  id         String       @id @default(cuid())
  url        String
  isMain     Boolean      @default(false)
  plantId    String
  plant      Plant        @relation(fields: [plantId], references: [id])
  Collection Collection[]
}

model Tag {
  id     String  @id @default(cuid())
  name   String  @unique
  plants Plant[] @relation("PlantTags")
}

model Trait {
  id        String        @id @default(cuid())
  name      String        @unique
  slug      String        @unique
  category  TraitCategory
  plants    PlantTrait[]

  @@index([slug])
  @@index([category])
}

model PlantTrait {
  plantId   String
  traitId   String
  plant     Plant   @relation(fields: [plantId], references: [id], onDelete: Cascade)
  trait     Trait   @relation(fields: [traitId], references: [id], onDelete: Cascade)

  @@id([plantId, traitId])
  @@index([traitId])
}

model Collection {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  userId String

  plants                  Plant[]
  originallyCreatedPlants Plant[] @relation("OriginalCollection")

  thumbnailImage   Image?  @relation(fields: [thumbnailImageId], references: [id])
  thumbnailImageId String?
}

// Stripe models
model StripeCustomer {
  id                String    @id @default(cuid())
  stripeCustomerId  String    @unique
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Subscription {
  id                        String    @id @default(cuid())
  stripeSubscriptionId      String    @unique
  userId                    String
  user                      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                      Plan
  status                    String    // active, past_due, canceled, unpaid, etc.
  currentPeriodStart        DateTime
  currentPeriodEnd          DateTime
  canceledAt                DateTime?
  cancelAtPeriodEnd         Boolean   @default(false)
  trialEnd                  DateTime?
  priceId                   String
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  
  @@index([userId])
  @@index([stripeSubscriptionId])
}

model StripeEvent {
  id                String    @id @default(cuid())
  stripeEventId     String    @unique
  type              String
  data              String    // JSON stringified event data
  processed         Boolean   @default(false)
  createdAt         DateTime  @default(now())
  
  @@index([stripeEventId])
  @@index([processed])
}

model UserPreference {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme             String    @default("dark")
  language          String    @default("en")
  emailNotifications Boolean  @default(true)
  pushNotifications  Boolean  @default(false)
  careReminders     Boolean   @default(true)
  reminderTime      String    @default("09:00")
  timezone          String    @default("America/New_York")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model PlantLike {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plantId   String
  plant     Plant    @relation(fields: [plantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, plantId])
  @@index([userId])
  @@index([plantId])
}

model CareReminder {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plantId           String
  plant             Plant     @relation(fields: [plantId], references: [id], onDelete: Cascade)
  type              String
  frequency         Int
  frequencyUnit     String    @default("days")
  lastCompleted     DateTime?
  nextDue           DateTime
  enabled           Boolean   @default(true)
  notificationSent  Boolean   @default(false)
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@index([plantId])
  @@index([nextDue])
}

// ========== SOCIAL FEATURES ==========

enum PostPrivacy {
  PUBLIC
  FOLLOWERS_ONLY
  PRIVATE
}

model Post {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String      @db.Text
  images    String[]
  privacy   PostPrivacy @default(PUBLIC)
  likes     PostLike[]
  comments  PostComment[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([userId])
  @@index([createdAt])
}

model PostLike {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model PostComment {
  id        String        @id @default(uuid())
  postId    String
  post      Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String        @db.Text
  parentId  String?
  parent    PostComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   PostComment[] @relation("CommentReplies")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

// ========== FORUM FEATURES ==========

model ForumCategory {
  id          String        @id @default(uuid())
  name        String        @unique
  slug        String        @unique
  description String?
  icon        String?
  threads     ForumThread[]
  createdAt   DateTime      @default(now())
}

model ForumThread {
  id         String            @id @default(uuid())
  categoryId String
  category   ForumCategory     @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  userId     String
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  title      String
  content    String            @db.Text
  isPinned   Boolean           @default(false)
  isLocked   Boolean           @default(false)
  views      Int               @default(0)
  replies    ForumReply[]
  votes      ForumThreadVote[]
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@index([categoryId])
  @@index([userId])
  @@index([createdAt])
}

model ForumReply {
  id        String           @id @default(uuid())
  threadId  String
  thread    ForumThread      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String           @db.Text
  parentId  String?
  parent    ForumReply?      @relation("ReplyReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   ForumReply[]     @relation("ReplyReplies")
  votes     ForumReplyVote[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([threadId])
  @@index([userId])
  @@index([parentId])
}

model ForumThreadVote {
  id        String      @id @default(uuid())
  threadId  String
  thread    ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  value     Int
  createdAt DateTime    @default(now())

  @@unique([threadId, userId])
  @@index([threadId])
}

model ForumReplyVote {
  id        String     @id @default(uuid())
  replyId   String
  reply     ForumReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  value     Int
  createdAt DateTime   @default(now())

  @@unique([replyId, userId])
  @@index([replyId])
}

// ========== NOTIFICATIONS ==========

enum NotificationType {
  POST_LIKE
  POST_COMMENT
  FORUM_REPLY
  CARE_REMINDER
  SYSTEM
  FOLLOW
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// ========== SUPPORT TICKETS ==========

enum TicketCategory {
  BUG
  FEATURE_REQUEST
  ACCOUNT
  PAYMENT
  OTHER
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model SupportTicket {
  id        String         @id @default(uuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject   String
  category  TicketCategory
  priority  TicketPriority @default(MEDIUM)
  status    TicketStatus   @default(OPEN)
  messages  TicketMessage[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  closedAt  DateTime?

  @@index([userId])
  @@index([status])
  @@index([priority])
}

model TicketMessage {
  id        String        @id @default(uuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   String        @db.Text
  isStaff   Boolean       @default(false)
  createdAt DateTime      @default(now())

  @@index([ticketId])
}
